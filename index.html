<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cierre de Operaciones | Rent a Car</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #0052cc; --bg: #f4f7f6; }
        body { background-color: var(--bg); font-family: 'Segoe UI', sans-serif; padding: 20px; }
        .card-custom { background: white; border-radius: 15px; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.1); padding: 25px; }
        .nav-pills .nav-link.active { background-color: var(--primary); }
        .check-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid #eee; }
        .btn-send { background-color: var(--primary); color: white; font-weight: bold; padding: 15px; border-radius: 10px; border: none; width: 100%; transition: 0.3s; }
        .btn-send:hover { background-color: #0747a6; transform: translateY(-2px); }
        #overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:999; align-items:center; justify-content:center; flex-direction:column; }
    </style>
</head>
<body>

<div id="overlay">
    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;"></div>
    <h5 class="mt-3 fw-bold">Enviando datos al Excel...</h5>
</div>

<div class="container" style="max-width: 500px;">
    <ul class="nav nav-pills nav-fill mb-4 bg-white p-2 rounded-pill shadow-sm">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-registro">REGISTRO</button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-stats" onclick="cargarEstadisticas()">ESTADÍSTICAS</button>
        </li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="tab-registro">
            <div class="card-custom">
                <h4 class="text-center mb-4 fw-bold">Cierre Diario</h4>
                
                <div class="mb-4">
                    <label class="form-label fw-bold text-secondary">Responsable</label>
                    <input type="text" id="responsable" class="form-control form-control-lg" placeholder="Nombre" required>
                </div>

                <div class="mb-4">
                    <h6 class="fw-bold text-secondary border-bottom pb-2">Checklist</h6>
                    <div class="check-row"><span>Pitbull en unidades</span><input type="checkbox" id="p1" class="form-check-input shadow-none"></div>
                    <div class="check-row"><span>Unidades cerradas</span><input type="checkbox" id="p2" class="form-check-input shadow-none"></div>
                    <div class="check-row"><span>Candados Bodegas</span><input type="checkbox" id="p3" class="form-check-input shadow-none"></div>
                    <div class="check-row"><span>Estación Combustible</span><input type="checkbox" id="p4" class="form-check-input shadow-none"></div>
                    <div class="check-row"><span>Basura Lavado</span><input type="checkbox" id="p5" class="form-check-input shadow-none"></div>
                    <div class="check-row"><span>Patio Ordenado</span><input type="checkbox" id="p6" class="form-check-input shadow-none"></div>
                </div>

                <div class="mb-4">
                    <label class="form-label fw-bold text-secondary">Evidencia (Fotos)</label>
                    <input type="file" id="fotos" class="form-control" multiple accept="image/*">
                </div>

                <button class="btn-send shadow" onclick="enviarReporte()">ENVIAR AHORA</button>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-stats">
            <div class="card-custom">
                <h5 class="text-center fw-bold mb-4">Actividad Semanal</h5>
                <canvas id="graficoSemanal" height="250"></canvas>
                <div class="table-responsive mt-4">
                    <table class="table table-sm">
                        <thead class="table-light"><tr><th>Fecha</th><th>Nombre</th></tr></thead>
                        <tbody id="tablaLogs"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycby_0XLNd6ZizQFBUaStwDht2FBFEFq_26Nx2HUBFt5mgQjuqgatZx1Nvwv6H3yZsidRIw/exec";

    async function enviarReporte() {
        const resp = document.getElementById('responsable').value;
        if (!resp) return alert("Por favor, ingresa tu nombre");

        document.getElementById('overlay').style.display = 'flex';

        // Procesar fotos a Base64
        const fotos = [];
        const files = document.getElementById('fotos').files;
        for (let f of files) {
            const b64 = await new Promise(res => {
                const reader = new FileReader();
                reader.onload = () => res({ data: reader.result, mimeType: f.type });
                reader.readAsDataURL(f);
            });
            fotos.push(b64);
        }

        const payload = {
            responsable: resp,
            checks: {
                p1: document.getElementById('p1').checked ? "SI" : "NO",
                p2: document.getElementById('p2').checked ? "SI" : "NO",
                p3: document.getElementById('p3').checked ? "SI" : "NO",
                p4: document.getElementById('p4').checked ? "SI" : "NO",
                p5: document.getElementById('p5').checked ? "SI" : "NO",
                p6: document.getElementById('p6').checked ? "SI" : "NO"
            },
            fotos: fotos
        };

        try {
            // Enviamos con mode: 'no-cors' para evitar bloqueos del navegador
            await fetch(WEB_APP_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify(payload)
            });
            
            alert("✅ Registro guardado en el Excel con éxito.");
            location.reload();
        } catch (error) {
            alert("Error al enviar: " + error);
            document.getElementById('overlay').style.display = 'none';
        }
    }

    let miChart = null;
    async function cargarEstadisticas() {
        try {
            const res = await fetch(WEB_APP_URL);
            const data = await res.json();
            
            const tbody = document.getElementById('tablaLogs');
            tbody.innerHTML = "";
            const diasConteo = [0, 0, 0, 0, 0, 0, 0]; // D L M M J V S

            data.slice().reverse().forEach(row => {
                const fecha = new Date(row.fecha);
                diasConteo[fecha.getDay()]++;
                tbody.innerHTML += `<tr><td>${fecha.toLocaleDateString()}</td><td>${row.responsable}</td></tr>`;
            });

            if (miChart) miChart.destroy();
            miChart = new Chart(document.getElementById('graficoSemanal'), {
                type: 'bar',
                data: {
                    labels: ['Dom', 'Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb'],
                    datasets: [{
                        label: 'Cierres',
                        data: diasConteo,
                        backgroundColor: '#0052cc',
                        borderRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    plugins: { legend: { display: false } }
                }
            });
        } catch (e) {
            console.log("Esperando datos...");
        }
    }
</script>
<script src="
