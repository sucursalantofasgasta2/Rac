<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n Rent a Car</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { background-color: #ebedef; font-family: 'Segoe UI', system-ui, sans-serif; padding: 20px; }
        .main-container { background: white; border-radius: 15px; padding: 30px; box-shadow: 0 8px 30px rgba(0,0,0,0.05); max-width: 650px; margin: auto; }
        
        /* Navegaci√≥n */
        .nav-pills { background: #f8f9fa; padding: 5px; border-radius: 12px; margin-bottom: 25px; }
        .nav-pills .nav-link { color: #495057; font-weight: 600; border-radius: 10px; transition: all 0.3s; }
        .nav-pills .nav-link.active { background-color: #fff; color: #0d6efd; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* Formulario */
        .check-group { background: #f8f9fa; border-radius: 12px; padding: 15px; margin-bottom: 20px; }
        .check-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px dashed #dee2e6; }
        .check-item:last-child { border-bottom: none; }
        .form-check-input { width: 1.6em; height: 1.6em; cursor: pointer; }

        /* Estad√≠sticas */
        .stat-card { border: 1px solid #e9ecef; border-radius: 12px; padding: 20px; text-align: center; background: #fff; height: 100%; box-shadow: 0 2px 4px rgba(0,0,0,0.02); }
        .stat-label { font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; color: #6c757d; font-weight: 700; margin-bottom: 10px; }
        .stat-percent { font-size: 2.5rem; font-weight: 800; line-height: 1; margin-bottom: 10px; }
        .stat-detail { font-size: 0.85rem; color: #adb5bd; }

        /* Faltas */
        .missing-row { display: flex; align-items: center; background: #fff5f5; border-left: 4px solid #dc3545; padding: 12px; margin-bottom: 8px; border-radius: 6px; }
        .missing-date { font-weight: 700; color: #495057; margin-left: 10px; }
        
        /* Loader */
        #loader { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.95); z-index:9999; align-items:center; justify-content:center; flex-direction:column; }
    </style>
</head>
<body>

<div id="loader">
    <div class="spinner-grow text-primary" role="status"></div>
    <h5 class="mt-3 fw-bold">Procesando informaci√≥n...</h5>
</div>

<div class="container">
    <div class="main-container">
        
        <ul class="nav nav-pills nav-fill">
            <li class="nav-item">
                <button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-registro">
                    <i class="fa-solid fa-pen-to-square me-2"></i>REGISTRO
                </button>
            </li>
            <li class="nav-item">
                <button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-stats" onclick="cargarKPIs()">
                    <i class="fa-solid fa-chart-simple me-2"></i>ESTAD√çSTICAS GESTI√ìN
                </button>
            </li>
        </ul>

        <div class="tab-content">
            
            <div class="tab-pane fade show active" id="tab-registro">
                <h3 class="text-center fw-bold mb-4 text-dark">Nuevo Cierre</h3>
                
                <div class="mb-4">
                    <label class="fw-bold mb-2 text-muted small">RESPONSABLE</label>
                    <div class="input-group">
                        <span class="input-group-text bg-light border-0"><i class="fa-solid fa-user text-primary"></i></span>
                        <input type="text" id="nombre" class="form-control bg-light border-0 py-3" placeholder="Nombre completo">
                    </div>
                </div>

                <div class="check-group">
                    <label class="fw-bold mb-3 text-muted small">CHECKLIST OPERATIVO</label>
                    <div class="check-item"><span>üê∂ Pitbull en unidades</span><input type="checkbox" id="c1" class="form-check-input"></div>
                    <div class="check-item"><span>üöó Unidades cerradas</span><input type="checkbox" id="c2" class="form-check-input"></div>
                    <div class="check-item"><span>üîí Candados Bodega</span><input type="checkbox" id="c3" class="form-check-input"></div>
                    <div class="check-item"><span>‚õΩ Combustible</span><input type="checkbox" id="c4" class="form-check-input"></div>
                    <div class="check-item"><span>üóëÔ∏è Basura Lavado</span><input type="checkbox" id="c5" class="form-check-input"></div>
                    <div class="check-item"><span>üßπ Patio Ordenado</span><input type="checkbox" id="c6" class="form-check-input"></div>
                </div>

                <div class="mb-4">
                    <label class="fw-bold mb-2 text-muted small">EVIDENCIA</label>
                    <input type="file" id="fotos" multiple accept="image/*" class="form-control">
                </div>

                <button class="btn btn-primary w-100 py-3 fw-bold rounded-3 shadow-sm" onclick="enviar()">
                    ENVIAR REPORTE
                </button>
            </div>

            <div class="tab-pane fade" id="tab-stats">
                <h4 class="text-center fw-bold mb-4">Tu Gesti√≥n de Cierre</h4>

                <div id="loadingStats" class="text-center py-5">
                    <div class="spinner-border text-primary"></div>
                    <p class="mt-2 text-muted">Calculando indicadores...</p>
                </div>

                <div id="panelStats" style="display:none;">
                    
                    <div class="row g-3 mb-4">
                        <div class="col-6">
                            <div class="stat-card">
                                <div class="stat-label">Semana Actual</div>
                                <div class="stat-percent" id="kpiWeek">0%</div>
                                <div class="progress" style="height: 6px;">
                                    <div class="progress-bar" id="barWeek" style="width: 0%"></div>
                                </div>
                                <div class="stat-detail mt-2" id="txtWeek">0/0 d√≠as</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="stat-card">
                                <div class="stat-label">Mes Actual</div>
                                <div class="stat-percent" id="kpiMonth">0%</div>
                                <div class="progress" style="height: 6px;">
                                    <div class="progress-bar" id="barMonth" style="width: 0%"></div>
                                </div>
                                <div class="stat-detail mt-2" id="txtMonth">0/0 d√≠as</div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4">
                        <h6 class="fw-bold text-danger mb-3"><i class="fa-solid fa-triangle-exclamation me-2"></i>D√≠as sin realizar cierre</h6>
                        <div id="listaFaltas"></div>
                        
                        <div id="okMessage" class="alert alert-success text-center py-4" style="display:none;">
                            <i class="fa-solid fa-medal fa-3x mb-3 text-success"></i>
                            <h5 class="fw-bold">¬°Gesti√≥n Impecable!</h5>
                            <p class="mb-0">Has realizado el cierre todos los d√≠as h√°biles.</p>
                        </div>
                    </div>

                    <div class="alert alert-light text-center small text-muted mt-3">
                        * La efectividad se mide sobre d√≠as h√°biles (Lunes a Viernes) transcurridos hasta hoy.
                    </div>
                </div>

                <button class="btn btn-outline-secondary w-100 mt-2" onclick="cargarKPIs()">Actualizar Tablero</button>
            </div>
        </div>
    </div>
</div>

<script>
    // --- PEGA AQU√ç TU URL DE LA VERSI√ìN 20 ---
    const API_URL = "https://script.google.com/macros/s/AKfycbxniGLGKiiJCFjkrZDt90Xiw9Cfqk5xCcxFDEMkqWZ_WYaSmLortp3ertE8jLDFZ0GvGw/exec";

    // --- FUNCI√ìN ENVIAR ---
    async function enviar() {
        const nom = document.getElementById('nombre').value.trim();
        if(!nom) return alert("‚ö†Ô∏è Falta el nombre del responsable.");
        
        document.getElementById('loader').style.display = 'flex';

        // Fotos
        const files = document.getElementById('fotos').files;
        let fotosData = [];
        if(files.length > 0) {
            for(let f of files) {
                try {
                    let b64 = await new Promise(r => {
                        let reader = new FileReader();
                        reader.onload = e => r({data: e.target.result, mimeType: f.type});
                        reader.readAsDataURL(f);
                    });
                    fotosData.push(b64);
                } catch(e) {}
            }
        }

        const data = {
            responsable: nom,
            checks: {
                p1: document.getElementById('c1').checked ? "SI" : "NO",
                p2: document.getElementById('c2').checked ? "SI" : "NO",
                p3: document.getElementById('c3').checked ? "SI" : "NO",
                p4: document.getElementById('c4').checked ? "SI" : "NO",
                p5: document.getElementById('c5').checked ? "SI" : "NO",
                p6: document.getElementById('c6').checked ? "SI" : "NO"
            },
            fotos: fotosData
        };

        try {
            await fetch(API_URL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(data) });
            
            // --- MENSAJE EXACTO SOLICITADO ---
            alert("EL CIERRE SE HA ENVIADO DE FORMA EXITOSA");
            // ---------------------------------
            
            window.location.reload();
        } catch(e) {
            alert("Error de conexi√≥n.");
            document.getElementById('loader').style.display = 'none';
        }
    }

    // --- FUNCI√ìN ESTAD√çSTICAS ---
    async function cargarKPIs() {
        document.getElementById('loadingStats').style.display = 'block';
        document.getElementById('panelStats').style.display = 'none';

        try {
            const res = await fetch(API_URL);
            const registros = await res.json();
            
            // Convertimos las fechas del Excel a un formato limpio "DD/MM/YYYY" para comparar
            const fechasCompletadas = registros.map(r => {
                let d = new Date(r.fecha);
                return d.toLocaleDateString(); // Esto quita la hora y deja solo la fecha local
            });

            let hoy = new Date();
            let mesActual = hoy.getMonth();
            let anioActual = hoy.getFullYear();
            
            // Calcular inicio de semana (Lunes)
            let diaSem = hoy.getDay(); 
            let diff = hoy.getDate() - diaSem + (diaSem == 0 ? -6 : 1);
            let lunesSemana = new Date(hoy.setDate(diff)); 
            hoy = new Date(); // Resetear hoy

            // Contadores
            let totalDiasMes = 0, hechosMes = 0;
            let totalDiasSem = 0, hechosSem = 0;
            let listaFaltas = [];

            // Recorrer desde d√≠a 1 del mes hasta HOY
            let iter = new Date(anioActual, mesActual, 1);
            
            while(iter <= hoy) {
                // Solo contamos Lunes(1) a Viernes(5)
                let dS = iter.getDay();
                if(dS >= 1 && dS <= 5) {
                    let fechaStr = iter.toLocaleDateString();
                    let realizado = fechasCompletadas.includes(fechaStr);
                    let nombreDia = iter.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric' });
                    nombreDia = nombreDia.charAt(0).toUpperCase() + nombreDia.slice(1);

                    // Calculo Mensual
                    totalDiasMes++;
                    if(realizado) hechosMes++;

                    // Calculo Semanal (si la fecha iterada es >= al lunes de esta semana)
                    // Truco simple: comparar timestamps ignorando hora
                    let tIter = new Date(iter.getFullYear(), iter.getMonth(), iter.getDate()).getTime();
                    let tLunes = new Date(lunesSemana.getFullYear(), lunesSemana.getMonth(), lunesSemana.getDate()).getTime();
                    
                    if(tIter >= tLunes) {
                        totalDiasSem++;
                        if(realizado) hechosSem++;
                    }

                    // Faltas (Si no est√° hecho y no es hoy - o si quieres ser estricto, incluye hoy)
                    if(!realizado) {
                        // Si quieres que HOY aparezca como falta si aun no lo hacen, quita el 'if'
                        // Dejaremos que hoy aparezca como falta para que baje el porcentaje y se motiven
                         listaFaltas.push(nombreDia);
                    }
                }
                iter.setDate(iter.getDate() + 1);
            }

            // Pintar Gr√°ficos
            pintarKPI('Week', hechosSem, totalDiasSem);
            pintarKPI('Month', hechosMes, totalDiasMes);

            // Pintar Lista
            const divFaltas = document.getElementById('listaFaltas');
            divFaltas.innerHTML = "";
            
            if(listaFaltas.length > 0) {
                listaFaltas.forEach(dia => {
                    divFaltas.innerHTML += `
                    <div class="missing-row">
                        <i class="fa-regular fa-calendar-xmark text-danger fa-lg"></i>
                        <span class="missing-date">${dia}</span>
                    </div>`;
                });
                document.getElementById('okMessage').style.display = 'none';
            } else {
                document.getElementById('okMessage').style.display = 'block';
            }

            document.getElementById('loadingStats').style.display = 'none';
            document.getElementById('panelStats').style.display = 'block';

        } catch(e) {
            console.error(e);
            alert("No se pudieron cargar los datos.");
        }
    }

    function pintarKPI(tipo, hechos, total) {
        if(total === 0) total = 1;
        let pct = Math.round((hechos / total) * 100);
        
        let color = 'bg-danger';
        let txtColor = 'text-danger';
        if(pct >= 50) { color = 'bg-warning'; txtColor = 'text-warning'; }
        if(pct >= 90) { color = 'bg-success'; txtColor = 'text-success'; }

        document.getElementById('kpi'+tipo).innerText = pct + "%";
        document.getElementById('kpi'+tipo).className = "stat-percent " + txtColor;
        
        let barra = document.getElementById('bar'+tipo);
        barra.style.width = pct + "%";
        barra.className = "progress-bar " + color;

        document.getElementById('txt'+tipo).innerText = `${hechos} de ${total} d√≠as h√°biles`;
    }
</script>
</body>
</html>

