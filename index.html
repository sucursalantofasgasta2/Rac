<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cierre Rent a Car | V6</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #0052cc; --bg: #f4f5f7; }
        body { background-color: var(--bg); font-family: 'Segoe UI', sans-serif; }
        .main-card { border: none; border-radius: 20px; box-shadow: 0 8px 30px rgba(0,0,0,0.08); background: white; padding: 25px; }
        .header-bar { background: #0052cc; color: white; padding: 20px 0; border-radius: 0 0 20px 20px; margin-bottom: 20px; }
        .task-row { border-bottom: 1px solid #eee; padding: 12px 5px; display: flex; align-items: center; justify-content: space-between; }
        .upload-box { border: 2px dashed #0052cc; border-radius: 15px; padding: 20px; text-align: center; background: #f0f7ff; cursor: pointer; }
        #loading { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.9); z-index:9999; align-items:center; justify-content:center; flex-direction:column; }
    </style>
</head>
<body>

<div id="loading">
    <div class="spinner-border text-primary" role="status"></div>
    <h4 class="mt-3 fw-bold">Guardando Reporte...</h4>
    <p>Subiendo fotos, no cierres la página.</p>
</div>

<div class="header-bar text-center">
    <h3 class="fw-bold m-0 text-uppercase">Cierre de Operaciones</h3>
</div>

<div class="container mb-5">
    <ul class="nav nav-pills nav-fill mb-4 bg-white rounded-pill shadow-sm p-1" id="pills-tab">
        <li class="nav-item"><button class="nav-link active rounded-pill" data-bs-toggle="pill" data-bs-target="#tab-form">REGISTRO</button></li>
        <li class="nav-item"><button class="nav-link rounded-pill" data-bs-toggle="pill" data-bs-target="#tab-stats" onclick="verEstadisticas()">ESTADÍSTICAS</button></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="tab-form">
            <div class="main-card">
                <form id="formCierre">
                    <div class="mb-4">
                        <label class="form-label fw-bold">RESPONSABLE</label>
                        <input type="text" id="responsable" class="form-control form-control-lg border-0 bg-light" placeholder="Nombre completo" required>
                    </div>

                    <div class="mb-4">
                        <div class="task-row"><span>Pitbull en unidades</span><input class="form-check-input fs-4" type="checkbox" id="v-pitbull"></div>
                        <div class="task-row"><span>Unidades cerradas</span><input class="form-check-input fs-4" type="checkbox" id="v-unidades"></div>
                        <div class="task-row"><span>Candados Bodegas</span><input class="form-check-input fs-4" type="checkbox" id="v-bodegas"></div>
                        <div class="task-row"><span>Candado Combustible</span><input class="form-check-input fs-4" type="checkbox" id="v-combustible"></div>
                        <div class="task-row"><span>Basura Lavado</span><input class="form-check-input fs-4" type="checkbox" id="v-basura"></div>
                        <div class="task-row"><span>Patio Ordenado</span><input class="form-check-input fs-4" type="checkbox" id="v-patio"></div>
                    </div>

                    <div class="upload-box mb-4" onclick="document.getElementById('fotosInput').click()">
                        <i class="fas fa-camera fa-2x text-primary mb-2"></i>
                        <p class="mb-0 fw-bold">Adjuntar Evidencias</p>
                        <small id="txtFotos" class="text-muted small">Haz clic aquí para subir varias fotos</small>
                        <input type="file" id="fotosInput" class="d-none" multiple accept="image/*" onchange="countFiles()">
                    </div>

                    <button type="submit" class="btn btn-primary w-100 py-3 rounded-pill fw-bold shadow">ENVIAR CIERRE</button>
                </form>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-stats">
            <div class="main-card">
                <h5 class="text-center fw-bold mb-4">Reportes Lunes a Viernes</h5>
                <canvas id="chartWeekly" style="max-height: 250px;"></canvas>
                <div class="table-responsive mt-4">
                    <table class="table table-sm" id="logTable">
                        <thead><tr><th>Fecha</th><th>Responsable</th><th>Fotos</th></tr></thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // URL V6 PROPORCIONADA
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycby9Sv2ShhPI2ZBkZuyrYxYSpwVQ5tAuDadyd-xG9_8tgK8_aB1Zvjc6I6ZiuvAwFl4SDg/exec";

    function countFiles() {
        const num = document.getElementById('fotosInput').files.length;
        document.getElementById('txtFotos').innerText = num + " fotos seleccionadas";
    }

    const toBase64 = file => new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve({ data: reader.result, mimeType: file.type });
        reader.onerror = error => reject(error);
    });

    document.getElementById('formCierre').addEventListener('submit', async (e) => {
        e.preventDefault();
        document.getElementById('loading').style.display = 'flex';

        const files = document.getElementById('fotosInput').files;
        const fotosData = await Promise.all(Array.from(files).map(f => toBase64(f)));

        const payload = {
            responsable: document.getElementById('responsable').value,
            checks: {
                pitbull: document.getElementById('v-pitbull').checked ? "SI" : "NO",
                unidades: document.getElementById('v-unidades').checked ? "SI" : "NO",
                bodegas: document.getElementById('v-bodegas').checked ? "SI" : "NO",
                combustible: document.getElementById('v-combustible').checked ? "SI" : "NO",
                basura: document.getElementById('v-basura').checked ? "SI" : "NO",
                patio: document.getElementById('v-patio').checked ? "SI" : "NO"
            },
            fotos: fotosData
        };

        try {
            // Usamos el método tradicional para evitar problemas de CORS en envíos grandes
            await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: { 'Content-Type': 'text/plain' }, // Evita pre-flight de CORS
                body: JSON.stringify(payload)
            });
            alert("¡Reporte Enviado! Verifica tu Google Sheets.");
            location.reload();
        } catch (err) {
            alert("Error al enviar: " + err);
            document.getElementById('loading').style.display = 'none';
        }
    });

    let myChart = null;
    async function verEstadisticas() {
        try {
            const response = await fetch(SCRIPT_URL);
            const data = await response.json();
            
            const tbody = document.querySelector("#logTable tbody");
            tbody.innerHTML = "";
            const counts = [0,0,0,0,0]; // L M X J V

            data.slice().reverse().forEach(item => {
                const date = new Date(item.fecha);
                const day = date.getDay();
                if(day >= 1 && day <= 5) counts[day-1]++;

                tbody.innerHTML += `<tr>
                    <td>${date.toLocaleDateString()}</td>
                    <td>${item.responsable}</td>
                    <td>${item.fotos ? '✅' : '-'}</td>
                </tr>`;
            });

            if(myChart) myChart.destroy();
            myChart = new Chart(document.getElementById('chartWeekly'), {
                type: 'bar',
                data: {
                    labels: ["Lun", "Mar", "Mié", "Jue", "Vie"],
                    datasets: [{ label: 'Cierres', data: counts, backgroundColor: '#0052cc' }]
                }
            });
        } catch (e) { console.error("Error cargando estadísticas", e); }
    }
</script>
</body>
</html>
