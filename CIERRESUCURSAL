<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control de Cierre - Rent a Car</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background-color: #f8f9fa; }
        .card { border-radius: 15px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .btn-submit { width: 100%; padding: 12px; font-weight: bold; }
    </style>
</head>
<body>

<nav class="navbar navbar-dark bg-primary mb-4">
    <div class="container">
        <span class="navbar-brand">ðŸš— Rent a Car - Cierre Diario</span>
    </div>
</nav>

<div class="container">
    <ul class="nav nav-pills nav-fill mb-4" id="pills-tab" role="tablist">
        <li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#tab-registro">Registrar Cierre</button></li>
        <li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#tab-stats" onclick="cargarEstadisticas()">EstadÃ­sticas</button></li>
    </ul>

    <div class="tab-content">
        <div class="tab-pane fade show active" id="tab-registro">
            <div class="card p-4">
                <form id="formularioCierre">
                    <div class="mb-3">
                        <label class="form-label">Nombre del Responsable</label>
                        <input type="text" id="responsable" class="form-control" placeholder="Ej: Juan PÃ©rez" required>
                    </div>

                    <h5 class="mt-4 mb-3">Checklist de Seguridad</h5>
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="pitbull">
                        <label class="form-check-label">Pitbull colocado en unidades</label>
                    </div>
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="unidades">
                        <label class="form-check-label">Unidades cerradas</label>
                    </div>
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="bodegas">
                        <label class="form-check-label">Candados de bodegas</label>
                    </div>
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="combustible">
                        <label class="form-check-label">Candado estaciÃ³n combustible</label>
                    </div>
                    <div class="form-check form-switch mb-2">
                        <input class="form-check-input" type="checkbox" id="basura">
                        <label class="form-check-label">Basura del lavado despejada</label>
                    </div>
                    <div class="form-check form-switch mb-3">
                        <input class="form-check-input" type="checkbox" id="patio">
                        <label class="form-check-label">Patio despejado (Herramientas/NeumÃ¡ticos)</label>
                    </div>

                    <button type="submit" id="btnGuardar" class="btn btn-primary btn-submit">GUARDAR CIERRE</button>
                </form>
            </div>
        </div>

        <div class="tab-pane fade" id="tab-stats">
            <div class="card p-4">
                <h5 class="text-center">Cierres Realizados (Lunes a Viernes)</h5>
                <canvas id="graficoCierres" height="150"></canvas>
                <hr>
                <h6>Ãšltimos Registros</h6>
                <div class="table-responsive">
                    <table class="table table-sm" id="tablaLogs">
                        <thead>
                            <tr><th>Fecha</th><th>Responsable</th><th>Estado</th></tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbz_IouJxqx_Z5Oi21J3BYhoTZrZ5DwcTeSisqWvgqSHfAwpARWAVdficoG6Yw5q-k5ebg/exec";

    // ENVIAR DATOS
    document.getElementById('formularioCierre').addEventListener('submit', async (e) => {
        e.preventDefault();
        const btn = document.getElementById('btnGuardar');
        btn.disabled = true;
        btn.innerText = "Enviando...";

        const datos = {
            responsable: document.getElementById('responsable').value,
            pitbull: document.getElementById('pitbull').checked ? "SI" : "NO",
            unidades: document.getElementById('unidades').checked ? "SI" : "NO",
            bodegas: document.getElementById('bodegas').checked ? "SI" : "NO",
            combustible: document.getElementById('combustible').checked ? "SI" : "NO",
            basura: document.getElementById('basura').checked ? "SI" : "NO",
            patio: document.getElementById('patio').checked ? "SI" : "NO"
        };

        try {
            await fetch(SCRIPT_URL, {
                method: 'POST',
                mode: 'no-cors',
                body: JSON.stringify(datos)
            });
            alert("Cierre registrado correctamente en la base de datos.");
            document.getElementById('formularioCierre').reset();
        } catch (error) {
            alert("Error al conectar con el servidor.");
        }
        btn.disabled = false;
        btn.innerText = "GUARDAR CIERRE";
    });

    // CARGAR ESTADÃSTICAS
    async function cargarEstadisticas() {
        const res = await fetch(SCRIPT_URL);
        const data = await res.json();
        
        // Procesar dÃ­as de la semana
        const dias = ["Domingo", "Lunes", "Martes", "MiÃ©rcoles", "Jueves", "Viernes", "SÃ¡bado"];
        const conteoDias = [0, 0, 0, 0, 0, 0, 0];
        
        const tbody = document.querySelector("#tablaLogs tbody");
        tbody.innerHTML = "";

        data.forEach(item => {
            const fechaObj = new Date(item.fecha);
            conteoDias[fechaObj.getDay()]++;
            
            // Llenar tabla
            let row = `<tr>
                <td>${fechaObj.toLocaleDateString()}</td>
                <td>${item.responsable}</td>
                <td>âœ…</td>
            </tr>`;
            tbody.innerHTML += row;
        });

        // Dibujar GrÃ¡fico
        new Chart(document.getElementById('graficoCierres'), {
            type: 'bar',
            data: {
                labels: ["Lun", "Mar", "Mie", "Jue", "Vie"],
                datasets: [{
                    label: 'Cierres Realizados',
                    data: conteoDias.slice(1, 6),
                    backgroundColor: '#0d6efd'
                }]
            }
        });
    }
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
